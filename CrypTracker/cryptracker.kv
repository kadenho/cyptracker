#:import Factory kivy.factory.Factory
#:import text_color_from_value main.text_color_from_value
#:import popup_update_text_size main.popup_update_text_size
ScreenManager:
    UserLoginScreen:
    CreateProfileScreen:
    MainDashboardScreen:
    AboutHelpScreen:
    SelectCryptoScreen:
    ViewHistoryScreen:

    PortfolioMenuScreen:
    NewCryptocurrencyScreen:
    PortfolioEntriesScreen:
    AddPortfolioEntryScreen:
    UpdatePortfolioEntryScreen:
    DeletePortfolioEntryScreen:
    CheckPortfolioScreen:

<UserLoginScreen>:
    name: 'UserLoginScreen'
    canvas.before:
        Color:
            rgba: (0,0,0,1)
        Rectangle:
            pos: self.pos
            size: self.size
    BoxLayout:
        orientation: 'vertical'
        Label:
            text: 'CrypTracker'
            font_size: sp(50)
            color: (1,1,1,1)
        Widget:
        BoxLayout:
            orientation: 'horizontal'
            Widget:
                size_hint: (.25, 1)
            Spinner:
                id: username_selector_spinner
                text: 'Select An Account'
                font_size: sp(30)
            Widget:
                size_hint: (.25, 1)
        Widget:
        BoxLayout:
            orientation: 'horizontal'
            Widget:
                size_hint: (.25, 1)
            Button:
                id: login_button
                text: 'Login'
                font_size: sp(30)
                on_press: app.on_login_button_press()
            Widget:
                size_hint: (.25, 1)
        Widget:
        BoxLayout:
            orientation: 'horizontal'
            Widget:
                size_hint: (.25, 1)
            Button:
                id: create_username_page_button
                text: 'Create New Username'
                font_size: sp(30)
                on_press: app.on_create_username_page_button_press()
            Widget:
                size_hint: (.25, 1)
        Widget:
<CreateProfileScreen>:
    name: 'CreateProfileScreen'
    canvas.before:
        Color:
            rgba: (0,0,0,1)
        Rectangle:
            pos: self.pos
            size: self.size
    BoxLayout:
        orientation: 'vertical'
        Label:
            text: 'Create Profile'
            font_size: sp(50)
            color: (1,1,1,1)
        Widget:
        Widget:
        Widget:
        BoxLayout:
            orientation: 'horizontal'
            Widget:
                size_hint: (.25, 1)
            Label:
                text: 'Enter New Username'
                font_size: sp(30)
            Widget:
                size_hint: (.25, 1)
        BoxLayout:
            orientation: 'horizontal'
            Widget:
                size_hint: (.25, 1)
            TextInput:
                id: new_username_textinput
                font_size: sp(30)
            Widget:
                size_hint: (.25, 1)
        Widget:
        BoxLayout:
            orientation: 'horizontal'
            Widget:
                size_hint: (.25, 1)
            Button:
                id: create_username_button
                text: 'Create New Username'
                font_size: sp(30)
                on_press: app.on_create_username_button_press()
            Widget:
                size_hint: (.25, 1)
        Widget:
<MainDashboardScreen>
    name: 'MainDashboardScreen'
    canvas.before:
        Color:
            rgba: (0,0,0,1)
        Rectangle:
            pos: self.pos
            size: self.size
    BoxLayout:
        orientation: 'vertical'
        Label:
            text: 'CrypTracker'
            font_size: sp(50)
            color: (1,1,1,1)
        Label:
            id: menu_username
            text: 'Welcome, username'
            font_size: sp(50)
            color: (1,1,1,1)
        Widget:
        Widget:
        Widget:
        BoxLayout:
            orientation: 'horizontal'
            Widget:
                size_hint: (.25, 1)
            Button:
                id: portfolio_button
                text: 'Portfolio'
                font_size: sp(30)
                on_press: app.on_portfolio_button_press()
            Widget:
                size_hint: (.25, 1)
        Widget:
        BoxLayout:
            orientation: 'horizontal'
            Widget:
                size_hint: (.25, 1)
            Button:
                id: historical_price_button
                text: 'Price History'
                font_size: sp(30)
                on_press:
                    app.populate_list()
                    app.on_historical_price_button_press()
            Widget:
                size_hint: (.25, 1)
        Widget:
        Widget:
        BoxLayout:
            orientation: 'horizontal'
            Widget:
                size_hint: (.25, 1)
            Button:
                id: switch_user_button
                text: 'Switch User'
                font_size: sp(30)
                on_press: app.on_switch_user_button_press()
            Widget:
                size_hint: (.25, 1)
        Widget:
        BoxLayout:
            orientation: 'horizontal'
            Widget:
                size_hint: (.25, 1)
            Button:
                id: about_help_button
                text: 'About/Help'
                font_size: sp(30)
                on_press: app.on_about_help_button_press()
            Widget:
                size_hint: (.25, 1)
        Widget:
<AboutHelpScreen>
    name: 'AboutHelpScreen'
    canvas.before:
        Color:
            rgba: (0,0,0,1)
        Rectangle:
            pos: self.pos
            size: self.size
    BoxLayout:
        orientation: 'vertical'
        Label:
            text: 'About/Help'
            font_size: sp(50)
            color: (1,1,1,1)
        Widget:
        Label:
            text: "Instructions"
        Label:
            text: 'Link to CoinGecko API documentation'
        BoxLayout:
            orientation: 'horizontal'
            Widget:
                size_hint: (.25, 1)
            Button:
                id: about_help_back_button
                text: 'Back'
                font_size: sp(30)
                on_press: app.on_about_help_back_button_press()
            Widget:
                size_hint: (.25, 1)
        Widget:

<Text>:
    color: (0.0, 0.0, 0.0)
    size_hint: (1, 1)
    text_size: self.width, None
    halign: 'center'
    valign: 'middle'

<FormattedButton>
    background_color: (0.25, 0.25, 0.25)
    color: (1.0, 1.0, 1.0)
    size_hint: (1, 1)
    text_size: self.width, None
    height: self.texture_size[1]
    halign: 'center'
    valign: 'middle'

<ScreenBoxLayout>
    canvas.before:
        Color:
            rgba: (0.95, 0.95, 0.95, 1.0)
        Rectangle:
            pos: self.pos
            size: self.size

<BackButton>
    size_hint: (0.25,0.1)

<SelectcryptoBox>
    orientation: 'horizontal'

    Button:
        text: '[' + root.crypto_symbol + '] ' + root.crypto_name
        background_color: (0.25, 0.25, 0.25)
        color: (1.0, 1.0, 1.0)
        size_hint: (0.5, 1)
        text_size: self.width, None
        height: self.texture_size[1]
        halign: 'left'
        valign: 'middle'
        on_press:
            app.select_crypto(root.crypto_id)
            app.root.current = 'ViewHistoryScreen'

    Text:
        text: 'Value: $' + root.crypto_value
        font_size: sp(12)
        size_hint: (0.25, 1)

    Text:
        text: 'Change: ' + root.crypto_percent_change + '%'
        font_size: sp(12)
        size_hint: (0.25, 1)

<SelectCryptoScreen>

    ScreenBoxLayout:
        orientation: 'vertical'

        BackButton:
            id: select_crypto_screen_home_button
            text: 'Home'
            on_press:
                root.manager.current = 'MainDashboardScreen'

        BoxLayout:
            orientation: 'vertical'

            Text:
                text: 'Historical Price Viewer'
                font_size: sp(40)
                font_name: 'Roboto-Bold'

            BoxLayout:
                orientation: 'horizontal'

                Widget:
                    orientation: 'vertical'
                    size_hint: (0.25, 1)

                TextInput:
                    id: select_crypto_text_input
                    multiline: False
                    size_hint: (0.5, 0.5)

                Button:
                    id: select_crypto_enter_button
                    text: 'Search'
                    background_color: (0.25, 0.25, 0.25)
                    color: (1.0, 1.0, 1.0)
                    text_size: self.width, None
                    height: self.texture_size[1]
                    halign: 'center'
                    valign: 'middle'
                    size_hint: (0.5,0.5)
                    on_press:
                        app.repopulate_list()

                Widget:
                    orientation: 'vertical'
                    size_hint: (0.25, 1)

        BoxLayout:
            id: cryptos_list_boxlayout
            orientation: 'vertical'

        BoxLayout:
            orientation: 'horizontal'
            size_hint: (1, 0.1)

            FormattedButton:
                id: select_crypto_list_back
                text: 'Back'
                on_press:
                    app.move_list_back()

            Widget:
                size_hint: (1.5, 1)

            FormattedButton:
                id: select_crypto_list_next
                text: 'Next'
                on_press:
                    app.move_list_forward()

<ViewHistoryScreen>:

    ScreenBoxLayout:
        orientation: 'vertical'

        BackButton:
            id: view_history_back_button
            text: 'Back'
            on_press:
                app.populate_list()
                root.manager.current = 'SelectCryptoScreen'

        BoxLayout:
            orientation: 'vertical'

            BoxLayout:
                orientation: 'horizontal'

                FormattedButton:
                    text: '30 Day Graph'
                    on_press:
                        app.display_month_chart()

                FormattedButton:
                    text: '7 Day Graph'
                    on_press:
                        app.display_week_chart()

                FormattedButton:
                    text: '1 Day Graph'
                    on_press:
                        app.display_day_chart()
            BoxLayout:
                size_hint: (1, 2)
                orientation: 'vertical'
                id: chart_box












<PortfolioMenuScreen>
    Label:
        text: app.title_text
        color: (0, 0, 0, 1)
        pos_hint: {'center': (0.5, 0.8)}
        font_size: 36
        text_size: self.size
        halign: 'center'
        valign: 'middle'

    BoxLayout:
        orientation: 'vertical'
        size_hint: (1.0,0.8)
        pos_hint: {'center': (0.5,0.4)}
        padding: (0, 100, 0, 50)
        spacing: 50

        CustomButton:
            text: 'Add New Cryptocurrency'
            text_color: (0.8, 0.8, 0.8, 1)
            size_hint_x: 0.8
            pos_hint: {'x': 0.5 - self.size[0]/(2*self.parent.size[0])}
            on_press:
                root.current = 'New Cryptocurrency'


        CustomButton:
            text: 'Portfolio Entries'
            text_color: (0.8, 0.8, 0.8, 1)
            size_hint_x: 0.8
            pos_hint: {'x': 0.5 - self.size[0]/(2*self.parent.size[0])}
            on_press:
                root.current = 'Portfolio Entries'

        CustomButton:
            text: 'Check Portfolio Value'
            text_color: (0.8, 0.8, 0.8, 1)
            size_hint_x: 0.8
            pos_hint: {'x': 0.5 - self.size[0]/(2*self.parent.size[0])}
            on_press:
                root.current = 'Check Portfolio'

        CustomButton:
            text: 'Change Color'
            text_color: (0.8, 0.8, 0.8, 1)
            size_hint_x: 0.8
            pos_hint: {'x': 0.5 - self.size[0]/(2*self.parent.size[0])}
            on_press:
                root.current = 'Change Color'

<NewCryptocurrencyScreen>
    Label:
        text: 'New Cryptocurrency'
        pos_hint: {'center': (0.5, 0.9)}
        font_size: 24
        text_size: self.size
        halign: 'center'
        valign: 'middle'

    BoxLayout:
        orientation: 'vertical'
        size_hint: (1,0.8)
        pos_hint: {'center': (0.5,0.4)}
        padding: (0, 0, 0, 50)
        spacing: 20

        Label:
            text: 'Please add a new cryptocurrency to the database.'
            pos_hint: {'center': (0.5, 0.5)}
            text_size: self.size
            halign: 'center'
            valign: 'middle'
        Label:
            text: 'Name'
            text_size: self.size
            halign: 'center'
            valign: 'middle'

        TextInput:
            id: crypto_name
            hint_text: 'Bitcoin'
            size_hint_x: 0.8
            pos_hint: {'x': 0.5 - self.size[0]/(2*self.parent.size[0])}

        Label:
            text: 'Symbol'
            text_size: self.size
            halign: 'center'
            valign: 'middle'

        TextInput:
            id: crypto_symbol
            hint_text: 'btc'
            size_hint_x: 0.8
            pos_hint: {'x': 0.5 - self.size[0]/(2*self.parent.size[0])}

        CustomButton:
            text: 'Add Cryptocurrency'
            size_hint_x: 0.5
            pos_hint: {'x': 0.25}
            on_press:
                app.add_crypto(name=root.ids.crypto_name.text, symbol=root.ids.crypto_symbol.text)

        CustomButton:
            text: 'Return to Menu'
            pos_hint: {'x': 0.5 - self.size[0]/(2*self.parent.size[0])}
            size_hint_x: 0.75
            on_press:
                root.current = 'Menu'

<PortfolioEntriesScreen>
    Label:
        text: 'Portfolio Entries'
        pos_hint: {'center': (0.5, 0.9)}
        size_hint: (1.0,0.1)
        font_size: 24
        text_size: self.size
        halign: 'center'
        valign: 'middle'

    BoxLayout:
        orientation: 'vertical'
        size_hint: (1,0.8)
        pos_hint: {'center': (0.5,0.4)}
        padding: (0, 0, 0, 50)
        spacing: 50

        CustomButton:
            text: 'Add Portfolio Entry'
            size_hint_x: 0.5
            pos_hint: {'x': 0.5 - self.size[0]/(2*self.parent.size[0])}
            on_press:
                root.current = 'Add Portfolio Entry'

        CustomButton:
            text: 'Update Portfolio Entry'
            size_hint_x: 0.5
            pos_hint: {'x': 0.5 - self.size[0]/(2*self.parent.size[0])}
            on_press:
                root.current = 'Update Portfolio Entry'

        CustomButton:
            text: 'Delete Portfolio Entry'
            size_hint_x: 0.5
            pos_hint: {'x': 0.5 - self.size[0]/(2*self.parent.size[0])}
            on_press:
                root.current = 'Delete Portfolio Entry'
                app.delete_portfolio_page(-1)

        CustomButton:
            text: 'Return to Menu'
            pos_hint: {'x': 0.125}
            size_hint_x: 0.75
            on_press:
                root.current = 'Menu'

<AddPortfolioEntryScreen>
    Label:
        text: 'Add Portfolio Entry'
        pos_hint: {'center': (0.5, 0.9)}
        size_hint: (1.0,0.1)
        font_size: 24
        text_size: self.size
        halign: 'center'
        valign: 'middle'

    BoxLayout:
        orientation: 'vertical'
        size_hint: (1,0.8)
        pos_hint: {'center': (0.5,0.4)}
        padding: (0, 0, 0, 0)
        spacing: 20

        Label:
            text: 'Please add a new portfolio entry to the database.'
            text_size: self.size
            halign: 'center'
            valign: 'middle'

        Spinner:
            id: spinner_crypto_id
            text: 'Crypto ID'
            values: app.crypto_ids
            size_hint: (0.5,1.0)
            pos_hint: {'x': 0.5 - self.size[0]/(2*self.parent.size[0])}
            on_press:
                self.values = app.crypto_ids

        Label:
            text: 'Date Purchased'
            text_size: self.size
            halign: 'center'
            valign: 'middle'

        TextInput:
            id: date_text
            hint_text: 'YYYY-MM-DD'
            size_hint_x: 0.8
            pos_hint: {'x': 0.5 - self.size[0]/(2*self.parent.size[0])}

        Label:
            text: 'Quantity Purchased'
            text_size: self.size
            halign: 'center'
            valign: 'middle'

        TextInput:
            id: quantity_text
            input_filter: 'int'
            hint_text: '1'
            size_hint_x: 0.8
            pos_hint: {'x': 0.5 - self.size[0]/(2*self.parent.size[0])}

        CustomButton:
            text: 'Add Portfolio Entry'
            size_hint_x: 0.5
            pos_hint: {'x': 0.5 - self.size[0]/(2*self.parent.size[0])}
            on_press:
                app.modify_portfolio_entry(root.ids.spinner_crypto_id.text, root.ids.date_text.text, root.ids.quantity_text.text, 'Add')
                quantity_text = ''
                date_text = ''

        CustomButton:
            text: 'Return to Portfolio Entries'
            pos_hint: {'x': 0.125}
            size_hint_x: 0.75
            on_press:
                root.current = 'Portfolio Entries'

<UpdatePortfolioEntryScreen>
    Label:
        text: 'Update Portfolio Entry'
        pos_hint: {'center': (0.5, 0.9)}
        size_hint: (1.0,0.1)
        font_size: 24
        text_size: self.size
        halign: 'center'
        valign: 'middle'

    BoxLayout:
        orientation: 'vertical'
        size_hint: (1,0.8)
        pos_hint: {'center': (0.5,0.45)}
        padding: (0, 0, 0, 0)
        spacing: 10

        Label:
            text: 'Please select a portfolio entry to update.'
            text_size: self.size
            halign: 'center'
            valign: 'middle'

        Spinner:
            id: spinner_update_portfolio
            text: '1'
            values: []
            size_hint: (0.5,1.0)
            pos_hint: {'x': 0.5 - self.size[0]/(2*self.parent.size[0])}
            option_cls: 'PortfolioUpdateSpinner'
            on_press:
                self.values = app.portfolio_info

        Spinner:
            id: update_spinner_crypto_id
            text: 'Crypto ID'
            values: app.crypto_ids
            size_hint: (0.5,1.0)
            pos_hint: {'x': 0.5 - self.size[0]/(2*self.parent.size[0])}
            on_press:
                self.values = app.crypto_ids

        Label:
            text: 'Date Purchased'
            text_size: self.size
            halign: 'center'
            valign: 'middle'

        TextInput:
            id: update_date_text
            hint_text: 'YYYY-MM-DD'
            size_hint_x: 0.8
            pos_hint: {'x': 0.5 - self.size[0]/(2*self.parent.size[0])}

        Label:
            text: 'Quantity Purchased'
            text_size: self.size
            halign: 'center'
            valign: 'middle'

        TextInput:
            id: update_quantity_text
            input_filter: 'int'
            hint_text: '1'
            size_hint_x: 0.8
            pos_hint: {'x': 0.5 - self.size[0]/(2*self.parent.size[0])}

        CustomButton:
            text: 'Update Portfolio Entry'
            size_hint_x: 0.5
            pos_hint: {'x': 0.5 - self.size[0]/(2*self.parent.size[0])}
            on_press:
                app.modify_portfolio_entry(root.ids.update_spinner_crypto_id.text,
                root.ids.update_date_text.text,
                root.ids.update_quantity_text.text,
                entry_id=root.ids.spinner_update_portfolio.text,
                operation='Update'
                )
                quantity_text = ''
                date_text = ''

        CustomButton:
            text: 'Return to Portfolio Entries'
            pos_hint: {'x': 0.125}
            size_hint_x: 0.75
            on_press:
                root.current = 'Portfolio Entries'


<DeletePortfolioEntryScreen>
    Label:
        text: 'Delete Portfolio Entry'
        pos_hint: {'center': (0.5, 0.9)}
        size_hint: (1.0,0.1)
        font_size: 24
        text_size: self.size
        halign: 'center'
        valign: 'middle'

    BoxLayout:
        orientation: 'vertical'
        size_hint: (1,0.8)
        pos_hint: {'center': (0.5,0.45)}
        padding: (0, 0, 0, 0)
        spacing: 10

        Label:
            text: 'Please select a portfolio entry to delete.'
            text_size: self.size
            halign: 'center'
            valign: 'middle'

        Spinner:
            id: spinner_delete_portfolio
            text: '1'
            values: []
            size_hint: (0.5,1.0)
            pos_hint: {'x': 0.5 - self.size[0]/(2*self.parent.size[0])}
            option_cls: 'PortfolioDeleteSpinner'
            on_press:
                self.values = app.portfolio_info

        Label:
            id: delete_crypto_id
            text: 'Crypto ID'
            color: app.outline_color
            outline_color: app.text_color
            size_hint: (0.5,1.0)
            pos_hint: {'x': 0.5 - self.size[0]/(2*self.parent.size[0])}

        Label:
            text: 'Date Purchased'
            text_size: self.size
            halign: 'center'
            valign: 'middle'

        Label:
            id: delete_date_text
            text: 'YYYY-MM-DD'
            color: app.outline_color
            outline_color: app.text_color
            size_hint_x: 0.8
            pos_hint: {'x': 0.5 - self.size[0]/(2*self.parent.size[0])}

        Label:
            text: 'Quantity Purchased'
            text_size: self.size
            halign: 'center'
            valign: 'middle'

        Label:
            id: delete_quantity_text
            text: '0'
            color: app.outline_color
            outline_color: app.text_color
            size_hint_x: 0.8
            pos_hint: {'x': 0.5 - self.size[0]/(2*self.parent.size[0])}

        CustomButton:
            text: 'Delete Portfolio Entry'
            size_hint_x: 0.5
            pos_hint: {'x': 0.5 - self.size[0]/(2*self.parent.size[0])}
            on_press:
                app.modify_portfolio_entry(
                entry_id=root.ids.spinner_delete_portfolio.text,
                operation='Delete'
                )

        CustomButton:
            text: 'Return to Portfolio Entries'
            pos_hint: {'x': 0.125}
            size_hint_x: 0.75
            on_press:
                root.current = 'Portfolio Entries'

<CheckPortfolioScreen>
    on_enter:
        app.add_value_check()
    Label:
        text: 'Portfolio Summary'
        pos_hint: {'center': (0.5, 0.9)}
        font_size: 24
        text_size: self.size
        halign: 'center'
        valign: 'middle'

    BoxLayout:
        orientation: 'vertical'
        size_hint: (1,0.8)
        pos_hint: {'center': (0.5,0.4)}
        padding: (0, 0, 0, 50)
        spacing: 20
        Label:
            text: 'Date of Report'
            text_size: self.size
            halign: 'center'
            valign: 'middle'

        Label:
            id: report_date
            text: f'{app.portfolio_report_date}'
            bold: True
            text_size: self.size
            halign: 'center'
            valign: 'middle'

        Label:
            text: 'Total Value'
            text_size: self.size
            halign: 'center'
            valign: 'middle'

        Label:
            id: total_value
            text: f'${app.portfolio_report_total:,.2f}'
            text_size: self.size
            bold: True
            color: app.text_color
            outline_width: 1
            halign: 'center'
            valign: 'middle'
            on_text:
                self.color = text_color_from_value(self, -100000, 100000)

        Label:
            text: 'Date of Last Report'
            text_size: self.size
            halign: 'center'
            valign: 'middle'

        Label:
            id: last_report_date
            text: f'{app.portfolio_report_previous_date}'
            text_size: self.size
            bold: True
            halign: 'center'
            valign: 'middle'

        Label:
            text: 'Change From Last'
            text_size: self.size
            halign: 'center'
            valign: 'middle'

        Label:
            id: percent_change
            text: f'{app.portfolio_report_percent_change:,}%'
            color: app.text_color
            text_size: self.size
            outline_width: 1
            bold: True
            halign: 'center'
            valign: 'middle'
            on_text:
                self.color = text_color_from_value(self, -100, 100)

        CustomButton:
            text: 'Return to Menu'
            pos_hint: {'x': 0.125}
            size_hint_x: 0.75
            on_press:
                root.current = 'Menu'


<Button>
    canvas.before:
        Color:
            rgb: self.background_color
        SmoothRoundedRectangle:
            size: self.size
            pos: self.pos
            radius: [18]
    background_color: app.button_color
    text_size: self.size
    halign: 'center'
    valign: 'middle'

<SpinnerOption>

    background_color: app.button_color

<TextInput>
    write_tab: False
    multiline: False

<Screen>
    canvas.before:
        Color:
            rgba: app.background_color
        Rectangle:
            pos: self.pos
            size: self.size

<Label>
    font_size: 24
    outline_width: 2
    outline_color: app.outline_color
    color: app.text_color